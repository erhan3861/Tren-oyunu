<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inglenook Shunting Oyunu</title>
<style>
:root {
    --bg:#0b0f26;
    --panel:#141a3f;
    --panel2:#192159;
    --ink:#eef0ff;
    --muted:#a9add6;
    --accent:#6c5dd3;
    --gold:#ffde59;
    --good:#2ecc71;
    --bad:#D02E2B;
}
* { box-sizing:border-box }
html, body {
    height:100%;
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
    background:radial-gradient(1200px 800px at 10% -10%, rgba(108,93,211,.18), transparent 30%), var(--bg);
    color:var(--ink);
}
.wrap {
    width: 95%;
    max-width: 1200px;
    margin: 24px auto;
    padding: 12px;
}
h1, h2 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 16px;
    font-size: clamp(22px, 3vw, 32px);
}
.main-board {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
    align-items: start;
}
.card {
    background:linear-gradient(180deg, var(--panel), var(--panel2));
    border:1px solid rgba(255,255,255,.07);
    border-radius:16px;
    box-shadow:0 12px 32px rgba(0,0,0,.35);
    padding: 20px;
}
.info-card h2 {
    font-size: 20px;
    margin-top: 5px;
    color: var(--gold);
}
.info-card p, .info-card .stat {
    color: var(--muted);
    line-height: 1.6;
    font-size: 15px;
    text-align: center;
}
.info-card hr {
    border: none; height: 1px;
    background-color: rgba(255, 255, 255, 0.1);
    margin: 24px 0;
}
.goalCar {
    color: #fff;
    text-align: center;
    margin: 5px auto;
    padding: 10px;
    border-radius: 5px;
    font-weight: bold;
    max-width: 200px;
}
#goalCars > div:last-child {
    border-radius: 5px 5px 10px 10px;
}
.game-area {
    position: relative;
    padding: 0;
    overflow: hidden;
}
#leftButton, #rightButton {
    background-color: var(--accent);
    position: absolute;
    font-size: x-large;
    bottom: 1ex;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.10);
    width: 60px;
    height: 50px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
#leftButton:active, #rightButton:active {
    transform: translateY(1px);
}
#leftButton { left: 35%; }
#rightButton { right: 35%; }
.btn {
    background:linear-gradient(180deg, #273074, #1a1f55);
    border:1px solid rgba(255,255,255,.10);
    color:#fff; padding:10px 14px;
    border-radius:12px; cursor:pointer; font-weight:700;
}
.btn.acc { background:linear-gradient(180deg,var(--accent),#4e42c2) }
.btn.good { background:linear-gradient(180deg,#2f9b63,#177845) }

/* SVG elements */
svg { display: block; }
.sleeper { fill: #6a73a8; }
.rail { fill: #a9add6; }
.buffer { fill: var(--bad); }
.control { fill: var(--gold); }
.controlBG { fill: #666; }
.clickTarget { opacity: 0; cursor: pointer; }
.uncoupler>path { fill: var(--gold); stroke:#888; stroke-width: 0.2; }
.carNumber { fill: #fff; font-size: 5px; user-select: none; text-anchor: middle; }
#couplerGroup>line { stroke: #666; stroke-width: 2px; }

/* Modal Styles */
.modal {
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(5,6,16,.65); backdrop-filter:blur(5px); z-index: 1000;
}
.modal.active { display:flex }
.modal .inner {
    background:linear-gradient(180deg, var(--panel), var(--panel2));
    border:1px solid rgba(255,255,255,.10); padding:28px; border-radius:16px;
    max-width:520px; text-align:center; box-shadow:0 16px 40px rgba(0,0,0,.4);
}
.modal h2 { margin-top: 0; font-size: 24px; color: var(--ink); }
.modal p { color: var(--muted); }
.pass {
    font-size:24px; font-weight:900; color:var(--gold); letter-spacing:1px;
    text-shadow:0 0 10px rgba(255,222,89,.9), 0 0 18px rgba(108,93,211,.6);
    word-break: break-all;
}
.copyline {
    display:flex; gap:12px; align-items:center; justify-content:center; margin:16px 0;
    background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px;
}
/* Responsive Design */
@media (max-width: 960px) {
    .main-board { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="wrap">
    <h1>Inglenook Shunting Oyunu</h1>
    <div class="main-board">
        <div class="card info-card">
            <h2>Görev</h2>
            <p>Lokomotifi kullanarak vagonları doğru sırayla birleştirip aşağıdaki treni oluşturun.</p>
            <div id="goalCars"></div>
            <p style="margin-top: 24px;"><button id="newTrainBtn" class="btn acc">Yeni Tren</button></p>
            <hr>
            <h2>Süre</h2>
            <p class="stat" id="timer">0:00</p>
        </div>
        
        <div class="card game-area">
            <svg id="gameSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 137 105">
                <defs>
                    <g id="straight">
                        <rect class="sleeper" width="8" height="1" x="0" y="0" /><rect class="sleeper" width="8" height="2" x="0" y="3" /><rect class="sleeper" width="8" height="2" x="0" y="7" /><rect class="sleeper" width="8" height="2" x="0" y="11" /><rect class="sleeper" width="8" height="1" x="0" y="15" />
                        <rect class="rail" width="1" height="16" x="6" y="0" /><rect class="rail" width="1" height="16" x="1" y="0" />
                    </g>
                    <g id="curve">
                        <rect class="sleeper" width="8" height="1" x="0" y="19" /><rect class="sleeper" width="8" height="2" x="1.748" y="14.591" transform="rotate(5.625)" /><rect class="sleeper" width="8" height="2" x="3.104" y="10.001" transform="rotate(11.5)" /><rect class="sleeper" width="8" height="2" x="3.911" y="5.366" transform="rotate(16.875)" /><rect class="sleeper" width="8" height="1" x="4.304" y="1.64" transform="rotate(22.5)" />
                        <path class="rail" d="M 2,20 C 2,14.484 3.086,9.023 5.197,3.927 L 4.273,3.545 C 2.112,8.762 1,14.353 1,20 Z" /><path class="rail" d="M 7,20 C 7,15.141 7.957,10.33 9.816,5.841 L 8.892,5.458 C 6.983,10.068 6,15.01 6,20 Z" />
                    </g>
                    <g id="buffer">
                        <rect class="sleeper" width="8" height="2" x="0" y="0" /><rect class="sleeper" width="8" height="1" x="0" y="4" />
                        <rect class="rail" width="1" height="5" x="1" y="0" /><rect class="rail" width="1" height="5" x="6" y="0" />
                        <path class="buffer" d="M 1,1 h 1 l 1,3 h -3 z" /><path class="buffer" d="M 6,1 h 1 l 1,3 h -3 z" />
                    </g>
                    <g id="turnout">
                        <rect class="sleeper" width="8" height="1" x="0" y="31" /><rect class="sleeper" width="12.5" height="3" x="0" y="27" /><path class="sleeper" d="m 0,23 v 2 H 3.77 L 8.55,25.92 8.95,23.96 3.97,23 Z" /><path class="sleeper" d="m 0,19 v 2 H 4.36 L 9.33,22.46 9.91,20.54 4.65,19 Z" /><path class="sleeper" d="m 0,15 v 2 H 5.24 L 10.42,19.1 11.19,17.25 5.64,15 Z" /><path class="sleeper" d="m 0,11 v 2 h 6.33 l 5.45,2.91 0.94,-1.76 L 6.84,11 Z" /><path class="sleeper" d="m 0,7 v 2 h 7.8 l 5.7,3.85 1.12,-1.66 L 8.42,7 Z" /><rect class="sleeper" width="8" height="2" x="0" y="3" /><rect class="sleeper" width="8" height="1" x="0" y="0" /><rect class="sleeper" width="8" height="2" x="10.332" y="-4.257" transform="rotate(39.375)" /><rect class="sleeper" width="8" height="1" x="9.74" y="-8.485" transform="rotate(45)" />
                        <rect class="controlBG" width="4" height="2" x="8" y="27.5" ry="1" /><circle class="control" cx="10" cy="28.5" r="1" />
                        <rect class="rail" width="1" height="32" x="1" y="0" /><path class="rail pointStraight" d="" /><path class="rail pointCurve" d="" />
                        <path class="rail" d="M 6,32 C 6,21.922 10.004,12.256 17.13,5.13 l 0.707,0.707 C 10.898,12.776 7.066,22.137 7,32 Z" />
                        <rect class="clickTarget" width="14.5" height="14" x="-1" y="20" rx="4" />
                    </g>
                    <g id="uncoupler">
                        <path d="m 80,27 1,-2 h -2 z" /><path d="m 80,35 1,2 h -2 z" />
                    </g>
                </defs>
                <g id="trackGroup"></g>
                <g id="couplerGroup"></g>
                <g id="trainGroup"></g>
                <g id="uncouplerControlGroup"></g>
            </svg>
            <button id="leftButton" title="Sola Sür">
                <svg width="24" height="24" viewBox="0 0 24 24" style="fill: white;"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"></path></svg>
            </button>
            <button id="rightButton" title="Sağa Sür">
                <svg width="24" height="24" viewBox="0 0 24 24" style="fill: white;"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"></path></svg>
            </button>
        </div>
    </div>
</div>

<div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="inner">
        <h2>🎉 Tebrikler, Bulmaca Çözüldü!</h2>
        <p>Kuleyi başarıyla taşıdınız. İşte bu başarının ödülü:</p>
        <div class="copyline">
            <span class="pass" id="pwd"></span>
            <button class="btn" id="copyBtn">📋 Kopyala</button>
        </div>
        <button class="btn good" id="okBtn">Harika!</button>
    </div>
</div>

<audio id="click" src="click.mp3"></audio>
<audio id="couple" src="couple.mp3"></audio>
<audio id="uncouple" src="uncouple.mp3"></audio>
<audio id="win" src="win.mp3"></audio>

<script>
'use strict';

// --- GAME LOGIC ---
var RADIUS = 40;
var LOCO_COLOUR = '#178F47';
var CAR_COLOURS = ['#7B9AFF', '#6E90FF', '#6186FF', '#547DFF', '#4873FF'];
var SKIP_COLOUR = '#2E5FFF';
var TRAIN_LENGTH = 5;
var CAR_COUNT = 8;
var PERMUTATIONS = factorial(CAR_COUNT) / factorial(CAR_COUNT - TRAIN_LENGTH);
var MAX_SPEED = 1;
var turnouts = [];
var uncouplers = [];
var controlsActive = false;
var locomotive = null;
var locoActualSpeed = 0;
var locoDesiredSpeed = 0;
var locoAcceleration = 0.05;
var allCars = [];
var carOrder = [];
var trains = [];
var timeStart;
var timePid;
var SVG_NS = 'http://www.w3.org/2000/svg';

// --- DOM ELEMENTS ---
const modal = document.getElementById('modal');
const pwdEl = document.getElementById('pwd');
const copyBtn = document.getElementById('copyBtn');
const okBtn = document.getElementById('okBtn');
const newTrainBtn = document.getElementById('newTrainBtn');
const FIXED_PASSWORD = 'SHUNTING-MASTER-2025-TREN-KODU';


var AbstractSegment = function() {};
AbstractSegment.prototype.nextSegment = null;
AbstractSegment.prototype.prevSegment = null;
AbstractSegment.prototype.turnout = null;
AbstractSegment.prototype.walk = function(distance) {
    if (distance < 0) {
        if (this.prevSegment) {
            return this.prevSegment.walk(distance + this.prevSegment.length);
        }
        return [this, 0, -distance];
    }
    if (distance > this.length) {
        if (this.nextSegment) {
            return this.nextSegment.walk(distance - this.length);
        }
        return [this, this.length, distance - this.length];
    }
    return [this, distance, 0];
};
AbstractSegment.prototype.calculateCoordinates = function(distance) {
    throw Error('Implemented by subclass');
};

var StraightSegment = function(startX, startY, deltaX, deltaY) {
    this.startX = startX;
    this.startY = startY;
    this.deltaX = deltaX;
    this.deltaY = deltaY;
    this.length = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
};
StraightSegment.prototype = new AbstractSegment();
StraightSegment.prototype.calculateCoordinates = function(distance) {
    var fraction = distance / this.length;
    return {
        x: this.startX + this.deltaX * fraction,
        y: this.startY + this.deltaY * fraction
    };
};

var CurveSegment = function(centerX, centerY, startDegrees, deltaDegrees) {
    this.centerX = centerX;
    this.centerY = centerY;
    this.startDegrees = startDegrees;
    this.deltaDegrees = deltaDegrees;
    var arc = Math.abs(deltaDegrees);
    arc = arc / 180 * Math.PI;
    this.length = RADIUS * arc;
};
CurveSegment.prototype = new AbstractSegment();
CurveSegment.prototype.calculateCoordinates = function(distance) {
    var fraction = distance / this.length;
    var arc = (this.startDegrees + this.deltaDegrees * fraction);
    arc = arc / 180 * Math.PI;
    return {
        x: this.centerX + Math.cos(arc) * RADIUS,
        y: this.centerY + Math.sin(arc) * RADIUS
    };
};

var Uncoupler = function(node, trackSegmentIndex) {
    this.node_ = node;
    this.trackSegment_ = PATH_SEGMENTS[trackSegmentIndex];
    var rect = createSvgElement('rect');
    rect.setAttribute('class', 'clickTarget');
    rect.setAttribute('width', 4);
    rect.setAttribute('height', 12);
    rect.setAttribute('x', 78);
    rect.setAttribute('y', 25);
    rect.setAttribute('rx', 1);
    rect.setAttribute('transform', this.node_.getAttribute('transform'));
    document.getElementById('uncouplerControlGroup').appendChild(rect);
    rect.addEventListener('click', this.activate.bind(this));
};
Uncoupler.prototype.activate = function() {
    if (!controlsActive) return;
    var audio = document.getElementById('uncouple');
    audio.volume = 0.5;
    audio.play();
    var node = this.node_;
    node.firstElementChild.setAttribute('transform', 'translate(0, 1)');
    node.lastElementChild.setAttribute('transform', 'translate(0, -1)');
    setTimeout(function() {
        node.firstElementChild.removeAttribute('transform');
        node.lastElementChild.removeAttribute('transform');
    }, 250);
    var car = this.getCar();
    if (car) {
        if (locoActualSpeed > 0 && locoDesiredSpeed <= 0) {
            locoActualSpeed = 0;
        }
        car.uncouple();
        checkWin();
    }
};
Uncoupler.prototype.getCar = function() {
    for (var i = 0; i < allCars.length; i++) {
        var car = allCars[i];
        if (car.frontSegment_ === this.trackSegment_ && car.frontDistance_ < 5) {
            return car.prevVehicle;
        }
    }
    return null;
};

var Turnout = function(node, rootSegmentIndex, straightSegmentIndex, curveSegmentIndex) {
    this.rootSegment_ = PATH_SEGMENTS[rootSegmentIndex];
    this.straightSegment_ = PATH_SEGMENTS[straightSegmentIndex];
    this.curveSegment_ = PATH_SEGMENTS[curveSegmentIndex];
    this.straightSegment_.turnout = this;
    this.curveSegment_.turnout = this;
    this.pointStraight_ = node.getElementsByClassName('pointStraight')[0];
    this.pointCurve_ = node.getElementsByClassName('pointCurve')[0];
    this.control_ = node.getElementsByClassName('control')[0];
    var clickTarget = node.getElementsByClassName('clickTarget')[0];
    clickTarget.addEventListener('click', this.toggle.bind(this));
    this.hasVehicle = false;
    this.set_(false);
};
Turnout.prototype.set_ = function(state) {
    this.state = state;
    if (state) {
        this.control_.setAttribute('cx', 9);
        this.pointStraight_.setAttribute('d', 'M 6,0 H 7 V 32 H 6 Z');
        this.pointCurve_.setAttribute('d', 'M 2.5,30.5 C 2.401,27.119 2.524,22.871 2.961,19.163 5.016,12.594 8.637,6.551 13.594,1.594 l 0.707,0.707 C 9.449,7.163 5.904,13.127 3.898,19.63 3.231,22.843 3.003,27.002 3,30.5 Z');
    } else {
        this.control_.setAttribute('cx', 11);
        this.pointStraight_.setAttribute('d', 'M 6,0 H 7 L 7,20 5.5,30.5 H 5 L 6,20 Z');
        this.pointCurve_.setAttribute('d', 'M 1,32 C 1,20.596 5.53,9.658 13.594,1.594 l 0.707,0.707 C 6.49,10.128 2.066,20.811 2,32 Z');
    }
    this.rootSegment_.nextSegment = state ? this.straightSegment_ : this.curveSegment_;
};
Turnout.prototype.toggle = function() {
    if (!this.hasVehicle) {
        document.getElementById('click').play();
        this.set_(!this.state);
    }
};

var Vehicle = function(isLocomotive) {
    this.LENGTH = isLocomotive ? 16 : 14;
    this.WIDTH = 8;
    this.nextVehicle = null;
    this.prevVehicle = null;
    this.textNode_ = null;
    this.AXLE_DISTANCE = this.LENGTH / 2 - 1;
    var g = createSvgElement('g');
    var rect = createSvgElement('rect');
    rect.setAttribute('rx', 1);
    rect.setAttribute('width', this.WIDTH);
    g.appendChild(rect);
    if (isLocomotive) {
        rect.setAttribute('height', this.LENGTH - 3);
        rect.setAttribute('y', 3);
        var head = createSvgElement('rect');
        g.appendChild(head);
        head.setAttribute('height', 6);
        head.setAttribute('width', this.WIDTH);
        head.setAttribute('rx', 3);
    } else {
        rect.setAttribute('height', this.LENGTH);
        var text = createSvgElement('text');
        text.setAttribute('class', 'carNumber');
        text.setAttribute('transform', 'translate(4, 9) rotate(0)'); // Corrected for upright numbers
        this.textNode_ = text;
        g.appendChild(text);
    }
    document.getElementById('trainGroup').appendChild(g);
    this.node = g;
    this.coupler = createSvgElement('line');
    document.getElementById('couplerGroup').appendChild(this.coupler);
    this.frontSegment_ = null;
    this.frontDistance_ = 0;
    this.backSegment_ = null;
    this.backDistance_ = 0;
};
Vehicle.prototype.setColour = function(colour) {
    for (var i = 0; i < this.node.childNodes.length; i++) {
        this.node.childNodes[i].setAttribute('fill', colour);
    }
};
Vehicle.prototype.setNumber = function(number) {
    var text = this.textNode_;
    while (text.firstChild) {
        text.removeChild(text.firstChild);
    }
    if (number !== undefined) {
        text.appendChild(document.createTextNode(number));
    }
};
Vehicle.prototype.couple = function(nextVehicle) {
    if (this.nextVehicle || nextVehicle.prevVehicle) {
        throw Error("Vehicle already coupled");
    }
    this.nextVehicle = nextVehicle;
    nextVehicle.prevVehicle = this;
    nextVehicle.moveTo(this.backSegment_, this.backDistance_ + nextVehicle.LENGTH + 2);
    var n = trains.indexOf(nextVehicle);
    if (n === -1) throw Error("Vehicle wasn't a train")
    trains.splice(n, 1);
    this.coupler.style.visibility = 'visible';
};
Vehicle.prototype.uncouple = function() {
    if (this.nextVehicle) {
        if (this.nextVehicle.prevVehicle !== this) {
            throw Error("nextVehicle wasn't connected to us");
        }
        this.nextVehicle.prevVehicle = null;
        trains.push(this.nextVehicle);
        this.nextVehicle = null;
    }
    this.coupler.style.visibility = 'hidden';
};
Vehicle.prototype.lengthToEnd = function() {
    var len = this.LENGTH + 2;
    if (this.nextVehicle) {
        len += this.nextVehicle.lengthToEnd();
    }
    return len;
};
Vehicle.prototype.moveTo = function(segment, distance) {
    this.backSegment_ = segment;
    this.backDistance_ = distance;
    this.moveBy(0);
};
Vehicle.prototype.moveBy = function(delta) {
    var locTrainEnd;
    if (delta >= 0) {
        if (!this.prevVehicle) {
            locTrainEnd = this.backSegment_.walk(this.backDistance_ + delta - this.AXLE_DISTANCE - this.LENGTH / 2 + this.lengthToEnd());
            if (locTrainEnd[2] !== 0) {
                locoActualSpeed = 0;
                delta -= locTrainEnd[2];
            }
        }
        var locBackAxle = this.backSegment_.walk(this.backDistance_ + delta);
        var locFrontAxle = locBackAxle[0].walk(locBackAxle[1] - 2 * this.AXLE_DISTANCE);
    } else {
        var locFrontAxle = this.backSegment_.walk(this.backDistance_ - 2 * this.AXLE_DISTANCE + delta);
        var locBackAxle = locFrontAxle[0].walk(locFrontAxle[1] + 2 * this.AXLE_DISTANCE);
        var backSegment = locBackAxle[0];
        if (!this.prevVehicle && backSegment.turnout && backSegment.prevSegment.nextSegment !== backSegment) {
            backSegment.turnout.toggle();
        }
        if (locFrontAxle[2] !== 0) {
            locoActualSpeed = 0;
        }
    }
    this.frontSegment_ = locFrontAxle[0];
    this.frontDistance_ = locFrontAxle[1];
    this.backSegment_ = locBackAxle[0];
    this.backDistance_ = locBackAxle[1];
    if (this.backSegment_.turnout) {
        this.backSegment_.turnout.hasVehicle = true;
    }
    var xyFrontAxle = locFrontAxle[0].calculateCoordinates(locFrontAxle[1]);
    var xyBackAxle = locBackAxle[0].calculateCoordinates(locBackAxle[1]);
    this.coupler.setAttribute('x1', xyBackAxle.x);
    this.coupler.setAttribute('y1', xyBackAxle.y);
    if (this.prevVehicle) {
        this.prevVehicle.coupler.setAttribute('x2', xyFrontAxle.x);
        this.prevVehicle.coupler.setAttribute('y2', xyFrontAxle.y);
    }
    var xyMid = {
        x: (xyBackAxle.x + xyFrontAxle.x) / 2,
        y: (xyBackAxle.y + xyFrontAxle.y) / 2
    };
    var angle = -Math.atan2(xyBackAxle.x - xyFrontAxle.x, xyBackAxle.y - xyFrontAxle.y);
    angle = angle / Math.PI * 180;
    this.node.setAttribute('transform',
        'rotate(' + angle + ', ' + xyMid.x + ',' + xyMid.y + ') ' +
        'translate(' + (xyMid.x - this.WIDTH / 2) + ',' + (xyMid.y - this.LENGTH / 2) + ')');
    if (this.nextVehicle) {
        this.nextVehicle.moveTo(this.backSegment_, this.backDistance_ + this.nextVehicle.LENGTH + 2);
    }
    if (delta > 0) {
        for (var i = 0; i < trains.length; i++) {
            var train = trains[i];
            if (train.frontSegment_ === locTrainEnd[0] && train.frontDistance_ <= locTrainEnd[1]) {
                var lastCar = this;
                while (lastCar.nextVehicle) {
                    lastCar = lastCar.nextVehicle;
                }
                var audio = document.getElementById('couple');
                audio.volume = 0.2;
                audio.play();
                lastCar.couple(train);
                locoActualSpeed = 0;
                checkWin();
            }
        }
    }
};

var HEADSHUNT_OVERFLOW = 160;
var PATH_SEGMENTS = [
    new StraightSegment(8, 104 + HEADSHUNT_OVERFLOW, 0, -HEADSHUNT_OVERFLOW),
    new StraightSegment(8, 104, 0, -32),
    new CurveSegment(48, 71, 180, 45),
    new StraightSegment(19.716, 42.716, 22.627, -22.628),
    new CurveSegment(70.627, 48.372, 225, 45),
    new StraightSegment(70.627, 8.372, 51, 0),
    new CurveSegment(48, 71, 225, 45),
    new StraightSegment(48, 31, 32, 0),
    new StraightSegment(80, 31, 51, 0),
    new CurveSegment(48, 71, 270, 45),
    new CurveSegment(104.568, 14.431, 135, -45),
    new StraightSegment(104.568, 54.431, 19, 0)
];

function init() {
    function bilateralLink(i, j) {
        PATH_SEGMENTS[i].nextSegment = PATH_SEGMENTS[j];
        PATH_SEGMENTS[j].prevSegment = PATH_SEGMENTS[i];
    }
    bilateralLink(0, 1); bilateralLink(1, 2); bilateralLink(2, 3);
    bilateralLink(3, 4); bilateralLink(4, 5); bilateralLink(2, 6);
    bilateralLink(6, 7); bilateralLink(7, 8); bilateralLink(6, 9);
    bilateralLink(9, 10); bilateralLink(10, 11);

    drawTrack('straight', 'translate(4, 103)');
    drawTrack('straight', 'translate(4, 87)');
    drawTrack('straight', 'translate(4, 71)');
    drawTrack('curve', 'translate(4, 51)');
    drawTrack('curve', 'rotate(22.5, -82.197, 55.555)');
    var turnout1Node = drawTrack('turnout', 'rotate(45, -1.077, 56.328)');
    drawTrack('curve', 'rotate(45, 23.065, 66.328)');
    drawTrack('curve', 'rotate(67.5, 36.082, 54.112)');
    drawTrack('straight', 'rotate(90, 41.127, 45.5)');
    drawTrack('straight', 'rotate(90, 49.127, 53.5)');
    drawTrack('straight', 'rotate(90, 57.127, 61.5)');
    drawTrack('buffer', 'rotate(90, 59.627, 64)');
    var turnout2Node = drawTrack('turnout', 'rotate(90, 26.5, 53.5)');
    drawTrack('straight', 'rotate(90, 34.5, 61.5)');
    drawTrack('straight', 'rotate(90, 42.5, 69.5)');
    drawTrack('straight', 'rotate(90, 50.5, 77.5)');
    drawTrack('buffer', 'rotate(90, 53, 80)');
    drawTrack('curve', 'rotate(-67.5, 70.117, -28.108)');
    drawTrack('curve', 'rotate(-90, 71.5, -13.068)');
    drawTrack('straight', 'rotate(90, 35.068, 85.5)');
    drawTrack('buffer', 'rotate(90, 37.568, 88)');
    var uncoupler1Node = drawTrack('uncoupler', 'rotate(-45, 48, 71)');
    var uncoupler2Node = drawTrack('uncoupler', '');
    var uncoupler3Node = drawTrack('uncoupler', 'rotate(45, 64, 32.372)');

    turnouts.push(new Turnout(turnout1Node, 2, 3, 6), new Turnout(turnout2Node, 6, 7, 9));
    uncouplers.push(new Uncoupler(uncoupler1Node, 4), new Uncoupler(uncoupler2Node, 8), new Uncoupler(uncoupler3Node, 10));

    for (var i = TRAIN_LENGTH; i >= 0; i--) {
        var div = document.createElement('div');
        div.className = 'goalCar';
        div.appendChild(document.createTextNode(i || '\xa0'));
        div.style.backgroundColor = i ? CAR_COLOURS[i - 1] : LOCO_COLOUR;
        document.getElementById('goalCars').appendChild(div);
    }
    locomotive = new Vehicle(true);
    locomotive.setColour(LOCO_COLOUR);
    for (var i = 0; i < CAR_COUNT; i++) {
        allCars[i] = new Vehicle(false);
        trains[i] = allCars[i];
    }
    
    reset(location.hash.substring(1));

    window.addEventListener('keydown', keydown);
    window.addEventListener('keyup', keyup);
    var leftButton = document.getElementById('leftButton');
    leftButton.addEventListener('mousedown', leftButtonDown);
    leftButton.addEventListener('touchstart', leftButtonDown);
    leftButton.addEventListener('mouseup', buttonUp);
    leftButton.addEventListener('touchend', buttonUp);
    var rightButton = document.getElementById('rightButton');
    rightButton.addEventListener('mousedown', rightButtonDown);
    rightButton.addEventListener('touchstart', rightButtonDown);
    rightButton.addEventListener('mouseup', buttonUp);
    rightButton.addEventListener('touchend', buttonUp);
    
    setInterval(updateTrains, 15);
}

function drawTrack(defId, transform) {
    var node = document.getElementById(defId).cloneNode(true);
    node.setAttribute('class', defId);
    node.removeAttribute('id');
    if (transform) node.setAttribute('transform', transform);
    document.getElementById('trackGroup').appendChild(node);
    return node;
}

function keydown(e) {
    if (!controlsActive) return;
    if (e.key === 'ArrowRight') {
        rightButtonDown();
    } else if (e.key === 'ArrowLeft') {
        leftButtonDown();
    } else if (e.key >= '1' && e.key <= '9') {
        var index = Number(e.key) - 1;
        if (turnouts[index]) turnouts[index].toggle();
    } else if (e.key === ' ' || e.key === 'Spacebar') {
        uncouplers.forEach(u => u.activate());
    }
    if (['ArrowRight', 'ArrowLeft', ' '].includes(e.key)) {
        e.preventDefault();
    }
}

function keyup(e) {
    if (!controlsActive) return;
    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
        buttonUp();
        e.preventDefault();
    }
}

function leftButtonDown() { locoDesiredSpeed = -MAX_SPEED; }
function rightButtonDown() { locoDesiredSpeed = MAX_SPEED; }
function buttonUp() { locoDesiredSpeed = 0; }

function reset(opt_key) {
    clearTimeout(timePid);
    var key = Number(opt_key);
    if (!key || key < 0 || key >= PERMUTATIONS) {
        key = Math.floor(Math.random() * PERMUTATIONS);
    }
    location.hash = key;
    
    var availableCars = [];
    for(var i = 0; i < CAR_COUNT; i++) availableCars.push(i);

    carOrder = [];
    var tempKey = key;
    for (var i = 1; i <= TRAIN_LENGTH; i++) {
        var index = tempKey % availableCars.length;
        carOrder.push(availableCars[index]);
        availableCars.splice(index, 1);
        tempKey = Math.floor(tempKey / availableCars.length);
    }
    
    var goalCarsDiv = document.getElementById('goalCars');
    while(goalCarsDiv.firstChild) goalCarsDiv.removeChild(goalCarsDiv.firstChild);

    for (var i = 0; i < TRAIN_LENGTH; i++) {
        var div = document.createElement('div');
        div.className = 'goalCar';
        div.textContent = i + 1;
        div.style.backgroundColor = CAR_COLOURS[i];
        goalCarsDiv.appendChild(div);
    }
    var divLoco = document.createElement('div');
    divLoco.className = 'goalCar';
    divLoco.innerHTML = '&nbsp;';
    divLoco.style.backgroundColor = LOCO_COLOUR;
    goalCarsDiv.appendChild(divLoco);

    locomotive.uncouple();
    trains = [];
    for (var i = 0; i < CAR_COUNT; i++) {
        allCars[i].uncouple();
        trains.push(allCars[i]);
        var orderIndex = carOrder.indexOf(i);
        if (orderIndex !== -1) {
            allCars[i].setColour(CAR_COLOURS[orderIndex]);
            allCars[i].setNumber(orderIndex + 1);
        } else {
            allCars[i].setColour(SKIP_COLOUR);
            allCars[i].setNumber(undefined);
        }
    }
    
    locoActualSpeed = 0;
    locoDesiredSpeed = 0;
    locomotive.moveTo(PATH_SEGMENTS[5], 20);
    allCars[0].moveTo(PATH_SEGMENTS[5], 36);
    allCars[1].moveTo(PATH_SEGMENTS[5], 52);
    allCars[2].moveTo(PATH_SEGMENTS[8], 20);
    allCars[3].moveTo(PATH_SEGMENTS[8], 36);
    allCars[4].moveTo(PATH_SEGMENTS[8], 52);
    allCars[5].moveTo(PATH_SEGMENTS[11], 20);
    allCars[6].moveTo(PATH_SEGMENTS[11], 36);
    allCars[7].moveTo(PATH_SEGMENTS[11], 52);
    
    timeStart = Date.now();
    timePid = setInterval(updateTimer, 1000);
    updateTimer();
    controlsActive = true;
}


function factorial(n) {
    for (var f = 1, i = 2; i <= n; i++) f *= i;
    return f;
}

function updateTrains() {
    if (locoActualSpeed !== locoDesiredSpeed) {
        var diff = Math.min(Math.abs(locoDesiredSpeed - locoActualSpeed), locoAcceleration);
        locoActualSpeed += (locoDesiredSpeed > locoActualSpeed ? 1 : -1) * diff;
    }
    if (locoActualSpeed !== 0) {
        turnouts.forEach(t => t.hasVehicle = false);
        trains.forEach(t => t.moveBy(locoActualSpeed));
        locomotive.moveBy(locoActualSpeed);
    }
}

function createSvgElement(name) {
    return document.createElementNS(SVG_NS, name);
}

function updateTimer() {
    var totalSeconds = Math.round((Date.now() - timeStart) / 1000);
    var minutes = Math.floor(totalSeconds / 60);
    var seconds = String(totalSeconds % 60).padStart(2, '0');
    document.getElementById('timer').textContent = `${minutes}:${seconds}`;
}

function checkWin() {
    var vehicle = locomotive;
    var isWin = true;
    for (var i = 0; i < TRAIN_LENGTH; i++) {
        vehicle = vehicle.nextVehicle;
        if (!vehicle || vehicle.textNode_.textContent != (i + 1)) {
            isWin = false;
            break;
        }
    }
    if (vehicle && vehicle.nextVehicle) isWin = false;

    if (isWin) {
        document.getElementById('win').play();
        clearInterval(timePid);
        controlsActive = false;
        
        // Show Modal
        pwdEl.textContent = FIXED_PASSWORD;
        modal.classList.add('active');
    }
}

// --- MODAL & CLIPBOARD LOGIC ---
okBtn.addEventListener('click', () => modal.classList.remove('active'));
modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
newTrainBtn.addEventListener('click', () => reset());

async function copyToClipboard(text) {
    try {
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
        } else {
            // Fallback for older browsers
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly', '');
            ta.style.position = 'fixed';
            ta.style.top = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        }
    } catch (e) {
        console.warn('Clipboard failed:', e);
        return false;
    }
}

async function handleCopy() {
    const textToCopy = (pwdEl.textContent || '').trim();
    if (!textToCopy) return;
    const ok = await copyToClipboard(textToCopy);
    copyBtn.textContent = ok ? '✅ Kopyalandı' : '❌ Hata';
    setTimeout(() => copyBtn.textContent = '📋 Kopyala', 1500);
}
copyBtn.addEventListener('click', handleCopy);

window.addEventListener('load', init);

</script>
</body>
</html>
